# ุฏููู ุงุฎุชุจุงุฑ Rate Limiting - P0-AUTH-1

**ุงูุชุงุฑูุฎ:** 2025-12-31
**ุงูุญุงูุฉ:** โ ุชู ุงููุดุฑ ููุฅูุชุงุฌ
**Function URL:** `https://us-central1-wawapp-952d6.cloudfunctions.net/createCustomToken`

---

## โ ุชู ุงููุดุฑ ุจูุฌุงุญ

### Cloud Function
- โ `createCustomToken` - ุชู ุงูุชุญุฏูุซ ุจูุฌุงุญ
- โ `rateLimiting.ts` - ุชู ุฑูุนู ููุดุฑู

### Firestore Rules
- โ `pin_rate_limits` collection - ูุญููุฉ ูู ุงูู clients

---

## ๐งช ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ ุงููุฏูู

### ุงูุงุฎุชุจุงุฑ 1: ูุญุงููุฉ ูุงุญุฏุฉ ุฎุงุทุฆุฉ
**ุงููุฏู:** ุงูุชุญูู ูู ุนุฑุถ ุงููุญุงููุงุช ุงููุชุจููุฉ

1. ุงูุชุญ ุชุทุจูู Driver
2. ุฃุฏุฎู ุฑูู ูุงุชู ุตุญูุญ
3. ุฃุฏุฎู PIN **ุฎุงุทุฆ** (ูุซูุงู: 0000)
4. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
   ```
   โ "ุงูุฑูู ุงูุณุฑู ุบูุฑ ุตุญูุญ. 9 ูุญุงููุงุช ูุชุจููุฉ"
   ```

---

### ุงูุงุฎุชุจุงุฑ 2: 3 ูุญุงููุงุช ุฎุงุทุฆุฉ โ ููู ุฏูููุฉ
**ุงููุฏู:** ุงูุชุญูู ูู ุงูููู ููุฏุฉ ุฏูููุฉ

1. ุฃุฏุฎู PIN ุฎุงุทุฆ 3 ูุฑุงุช ูุชุชุงููุฉ
2. **ุงููุชูุฌุฉ ุงููุชููุนุฉ ุจุนุฏ ุงููุญุงููุฉ ุงูุซุงูุซุฉ:**
   ```
   ๐ "ุงูุญุณุงุจ ูููู. ุญุงูู ุจุนุฏ 60 ุซุงููุฉ"
   ```
3. ุญุงูู ุชุณุฌูู ุงูุฏุฎูู ูุจุงุดุฑุฉ
4. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
   ```
   ๐ "ุงูุญุณุงุจ ูููู ููุฏุฉ ุฏูููุฉ ุจุณุจุจ ุงููุญุงููุงุช ุงูุฎุงุทุฆุฉ"
   ```
5. ุงูุชุธุฑ 60 ุซุงููุฉ
6. ุญุงูู ูุฑุฉ ุฃุฎุฑู
7. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
   ```
   โ ูุณูุญ ุจุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู
   ```

---

### ุงูุงุฎุชุจุงุฑ 3: 6 ูุญุงููุงุช ุฎุงุทุฆุฉ โ ููู 5 ุฏูุงุฆู
**ุงููุฏู:** ุงูุชุญูู ูู ุงูููู ููุฏุฉ 5 ุฏูุงุฆู

1. ุฃุฏุฎู PIN ุฎุงุทุฆ 6 ูุฑุงุช ูุชุชุงููุฉ (ุงูุชุธุฑ ุฏูููุฉ ุจุนุฏ ุงูู 3 ุงูุฃููู)
2. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
   ```
   ๐ "ุงูุญุณุงุจ ูููู ููุฏุฉ 5 ุฏูุงุฆู ุจุณุจุจ ุงููุญุงููุงุช ุงูุฎุงุทุฆุฉ"
   ```

---

### ุงูุงุฎุชุจุงุฑ 4: 10 ูุญุงููุงุช ุฎุงุทุฆุฉ โ ููู ุณุงุนุฉ
**ุงููุฏู:** ุงูุชุญูู ูู ุงูููู ููุฏุฉ ุณุงุนุฉ

1. ุฃุฏุฎู PIN ุฎุงุทุฆ 10 ูุฑุงุช (ุงูุชุธุฑ ุงููุชุฑุงุช ุงููุทููุจุฉ)
2. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
   ```
   ๐ "ุงูุญุณุงุจ ูููู ููุฏุฉ ุณุงุนุฉ ุจุณุจุจ ุงููุญุงููุงุช ุงููุซูุฑุฉ"
   ```

---

### ุงูุงุฎุชุจุงุฑ 5: ุฅุนุงุฏุฉ ุชุนููู ุงูุนุฏุงุฏ ุนูุฏ ุงููุฌุงุญ
**ุงููุฏู:** ุงูุชุญูู ูู reset ุงูุนุฏุงุฏ

1. ุฃุฏุฎู PIN ุฎุงุทุฆ 5 ูุฑุงุช (ุงูุชุธุฑ ุฏูููุฉ ุจุนุฏ ุงูู3 ุงูุฃููู)
2. ุฃุฏุฎู PIN **ุตุญูุญ**
3. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
   ```
   โ ุชุณุฌูู ุฏุฎูู ูุงุฌุญ
   ```
4. ุงุฎุฑุฌ ูู ุงูุชุทุจูู
5. ุญุงูู ุชุณุฌูู ุงูุฏุฎูู ุจู PIN **ุฎุงุทุฆ** ูุฑุฉ ุฃุฎุฑู
6. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
   ```
   โ "ุงูุฑูู ุงูุณุฑู ุบูุฑ ุตุญูุญ. 9 ูุญุงููุงุช ูุชุจููุฉ"
   (ูููุณ 4 - ูุฃู ุงูุนุฏุงุฏ ุชู reset)
   ```

---

### ุงูุงุฎุชุจุงุฑ 6: ุฃุฑูุงู ูุฎุชููุฉ ููุง ุนุฏุงุฏุงุช ูููุตูุฉ
**ุงููุฏู:** ุงูุชุญูู ูู ุนุฒู ุงูุนุฏุงุฏุงุช

1. ุงููุงุชู A: ุฃุฏุฎู PIN ุฎุงุทุฆ 5 ูุฑุงุช
2. **ุงููุชูุฌุฉ:**
   ```
   โ "5 ูุญุงููุงุช ูุชุจููุฉ"
   ```
3. ุงููุงุชู B: ุญุงูู ุชุณุฌูู ุงูุฏุฎูู
4. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
   ```
   โ ูุจุฏุฃ ูู 10 ูุญุงููุงุช (ุบูุฑ ูุชุฃุซุฑ ุจุงููุงุชู A)
   ```

---

## ๐ ูุญุต Logs

### ุนุฑุถ Logs ูุจุงุดุฑ:
```bash
firebase functions:log --only createCustomToken
```

### Logs ุงููุชููุนุฉ:

#### ูุญุงููุฉ ูุงุฌุญุฉ:
```
[createCustomToken] Rate limit check passed { remainingAttempts: 10 }
[createCustomToken] Custom token created for user: xxx
[RateLimit] Reset counter after successful login
```

#### ูุญุงููุฉ ูุงุดูุฉ (ุฃูู ูุฑุฉ):
```
[createCustomToken] Rate limit check passed { remainingAttempts: 10 }
[createCustomToken] Invalid PIN for user: xxx
[RateLimit] Recorded failed attempt 1/10
```

#### ูุญุงููุฉ ูุงุดูุฉ (ุงููุฑุฉ ุงูุซุงูุซุฉ - ููู):
```
[createCustomToken] Rate limit check passed { remainingAttempts: 8 }
[createCustomToken] Invalid PIN for user: xxx
[RateLimit] Recorded failed attempt 3/10 { lockLevel: 1, lockDuration: '1min' }
```

#### ูุญุงููุฉ ูุญุธูุฑุฉ:
```
[RateLimit] Account locked { remainingSeconds: 58, lockLevel: 1 }
[createCustomToken] Rate limit exceeded for +22236123456
```

---

## ๐ ูุญุต Firestore

### ูุฑุงุฌุนุฉ ุงูุจูุงูุงุช ูู Console:

1. ุงูุชุญ [Firestore Console](https://console.firebase.google.com/project/wawapp-952d6/firestore)
2. ุงุจุญุซ ุนู collection `pin_rate_limits`
3. **ุงูุจููุฉ ุงููุชููุนุฉ:**

```javascript
pin_rate_limits/
  22236123456/  // ุฑูู ุงููุงุชู ุจุฏูู +
    {
      phoneE164: "+22236123456",
      attemptCount: 3,
      lockLevel: 1,
      lockedUntil: Timestamp(2025-12-31 14:35:00),
      lastAttemptAt: Timestamp(2025-12-31 14:34:00),
      createdAt: Timestamp(2025-12-31 14:33:00),
      updatedAt: Timestamp(2025-12-31 14:34:00)
    }
```

### ุงูุชุญูู ูู Security Rules:

**ุญุงูู ุงููุฑุงุกุฉ ูู ุงูู Client:**
```dart
// ูู Flutter app:
final doc = await FirebaseFirestore.instance
  .collection('pin_rate_limits')
  .doc('22236123456')
  .get();
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```
โ [cloud_firestore/permission-denied]
   Missing or insufficient permissions
```
โ **ูุฐุง ุตุญูุญ** - ุงูู clients ูุง ูุณุชุทูุนูู ุงููุฑุงุกุฉ/ุงููุชุงุจุฉ

---

## โ๏ธ ุงููุดุงูู ุงููุญุชููุฉ ูุงูุญููู

### ุงููุดููุฉ 1: "Function not found"
**ุงูุณุจุจ:** ูู ูุชู ูุดุฑ ุงูู function ุจุดูู ุตุญูุญ
**ุงูุญู:**
```bash
cd functions
npm run build
firebase deploy --only functions:createCustomToken
```

### ุงููุดููุฉ 2: "Module not found: rateLimiting"
**ุงูุณุจุจ:** ุงูููู `rateLimiting.ts` ูู ูุชู ุฑูุนู
**ุงูุญู:**
```bash
# ุชุญูู ูู ูุฌูุฏ ุงูููู
ls functions/src/auth/rateLimiting.ts

# ุฃุนุฏ build ููุดุฑ
cd functions && npm run build
firebase deploy --only functions:createCustomToken
```

### ุงููุดููุฉ 3: ุงูุนุฏุงุฏ ูุง ูุนูู (ูุณูุญ ุจูุญุงููุงุช ุบูุฑ ูุญุฏูุฏุฉ)
**ุงูุณุจุจ:** ุฎุทุฃ ูู Firestore permissions
**ุงูุชุญูู:**
```bash
# ุดุงูุฏ ุงูู logs
firebase functions:log --only createCustomToken

# ุงุจุญุซ ุนู:
[RateLimit] Error checking rate limit
```

**ุงูุญู:**
```bash
# ุฃุนุฏ ูุดุฑ Firestore rules
firebase deploy --only firestore:rules
```

### ุงููุดููุฉ 4: ุงูุฑุณุงูุฉ ุจุงูุฅูุฌููุฒูุฉ ุจุฏูุงู ูู ุงูุนุฑุจูุฉ
**ุงูุณุจุจ:** ุงูุชุทุจูู ูุณุชุฎุฏู ุงููุณุฎุฉ ุงููุฏููุฉ ูู `auth_error_messages.dart`
**ุงูุญู:**
```bash
# ุฃุนุฏ build ุงูุชุทุจูู
cd apps/wawapp_driver
flutter clean
flutter pub get
flutter build apk
```

---

## ๐ Checklist ุงููุดุฑ ุงูููุงุฆู

### Backend (ุชู โ)
- [x] Cloud Function `createCustomToken` deployed
- [x] Firestore rules deployed
- [x] `pin_rate_limits` collection protected

### Frontend (ูุญุชุงุฌ ุชุญุฏูุซ)
- [ ] ุชุทุจูู Driver - build ุฌุฏูุฏ ุจู error messages ุงููุญุฏุซุฉ
- [ ] ุชุทุจูู Client - build ุฌุฏูุฏ (ุฅุฐุง ูุงู ูุณุชุฎุฏู PIN)
- [ ] ูุดุฑ ููู pilot group ุนุจุฑ Firebase App Distribution

### Testing
- [ ] ุงุฎุชุจุงุฑ ูุฏูู ูุงูู (6 ุงุฎุชุจุงุฑุงุช ุฃุนูุงู)
- [ ] ูุญุต Logs ููุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ุฃุฎุทุงุก
- [ ] ูุญุต Firestore ููุชุฃูุฏ ูู ุฅูุดุงุก records ุตุญูุญุฉ

### Monitoring
- [ ] ุฅุนุฏุงุฏ Alerts ูู Cloud Console ููุฃุฎุทุงุก
- [ ] ูุฑุงูุจุฉ Logs ููุฏุฉ 24 ุณุงุนุฉ ุงูุฃููู
- [ ] ุชุชุจุน ุดูุงูู ุงููุณุชุฎุฏููู (ุฅุฐุง ูุฌุฏุช)

---

## ๐ฏ ูุนุงููุฑ ุงููุฌุงุญ

ุจุนุฏ 48 ุณุงุนุฉ ูู ุงููุดุฑุ ุชุญูู ูู:

1. โ **ูุง ุชูุฌุฏ ุฃุฎุทุงุก ูู Logs**
   ```bash
   firebase functions:log --only createCustomToken | grep ERROR
   # ุงููุชูุฌุฉ: ูุงุฑุบ
   ```

2. โ **Rate limiting ูุนูู ุจุดูู ุตุญูุญ**
   - ุชู ุญุธุฑ 10+ ูุญุงููุงุช
   - ูุง ุชูุฌุฏ ุดูุงูู ูู ูุณุชุฎุฏููู ุดุฑุนููู

3. โ **ุงูุฃุฏุงุก ููุจูู**
   - ุฒูุงุฏุฉ latency <100ms
   - ูุง ุชูุฌุฏ timeouts

4. โ **ูุง ุชูุฌุฏ ุชูููุฉ ุบูุฑ ูุชููุนุฉ**
   - ุชุญูู ูู Firebase Usage
   - Firestore reads/writes ุถูู ุงููุชููุน (~$0.12/ุดูุฑ)

---

## ๐ ุงูุฏุนู

ุฅุฐุง ูุงุฌูุช ูุดุงูู:
1. ุฑุงุฌุน Logs: `firebase functions:log --only createCustomToken`
2. ุฑุงุฌุน Firestore Console: [ููุง](https://console.firebase.google.com/project/wawapp-952d6/firestore)
3. ุฑุงุฌุน ููู ุงูุชูููุฐ: `P0_AUTH_1_IMPLEMENTATION_SUMMARY.md`

---

**ุขุฎุฑ ุชุญุฏูุซ:** 2025-12-31
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุงุฎุชุจุงุฑ
